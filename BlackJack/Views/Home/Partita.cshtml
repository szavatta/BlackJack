@{
    ViewData["Title"] = "Home Page";
    @model Classes.Gioco;
}
@Html.Hidden("IdGiocatore", (string)ViewBag.IdGiocatore)

<div class="text-center p-2">
    <div class="row">
        <div>
            <h2>@Model.Nome</h2>
        </div>
        <div class="col-lg-3 pt-4">
            <div id="scarti" class="w-100 d-none">
                <img src="" />
                <div id="num-scarti"></div>
            </div>
        </div>
        <div id="mazziere" class="col-lg-6 p-2">
            <div id="nome-mazziere"></div>
            <div id="cassa-mazziere"></div>
            <div id="carte-mazziere" class="d-flex justify-content-center"></div>
        </div>
        <div class="col-lg-2 offset-lg-1 mb-1 div-partecipa">
            <input type='text' value='' class='txtNomeGiocatore form-control ml-1 d-none' placeholder="Nome giocatore" />
            <input type='button' value='Partecipa' class='btnPartecipa btn btn-info w-100 d-none' />
        </div>

        <div id="giocatori" class="col-lg-12 mt-5 row">
            <div class="giocatorestamp col-lg-3 d-none p-2 border border-light">
                <div class="nome-giocatore"></div>
                <div class="cassa-giocatore"></div>
                <div class="carte-giocatore d-flex justify-content-center"></div>
                <div class="opzioni-giocatore d-flex justify-content-center">
                    <input type='text' value='' class='txtPuntata form-control ml-1 d-none' />
                    <input type='button' value='Punta' class='btnPunta btn btn-info d-none' />
                    <input type='button' value='Pesca' class='btnPesca btn btn-info d-none' />
                    <input type='button' value='Stai' class='btnStai btn btn-info d-none' />
                    <input type='button' value='Esci' class='btnEsci btn btn-info d-none' />
                    <input type='button' value='Raddoppia' class='btnRaddoppia btn btn-info d-none' />
                    <input type='button' value='Split' class='btnSplit btn btn-info d-none' />
                    <input type='button' value='Nuova mano' class='btnNuovaMano btn btn-info d-none' />
                </div>
                <div class="fiches-giocatore d-flex flex-wrap justify-content-center mt-2 d-none">
                    <img src="~/Fiches/1.png" valore="1" />
                    <img src="~/Fiches/5.png" valore="5" />
                    <img src="~/Fiches/25.png" valore="25" />
                    <img src="~/Fiches/50.png" valore="50" />
                    <img src="~/Fiches/100.png" valore="100" />
                    <img src="~/Fiches/500.png" valore="500" />
                    <img src="~/Fiches/x.png" valore="x" />
                </div>
            </div>
        </div>
    </div>

</div>

<script>

    let timer = null;
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    let idPartita = urlParams.get('id');

    SetInterval();

    $(document).ready(function () {

        $(document).on("click", ".btnPunta", function () {
            let idGiocatore = $(this).closest(".giocatore").attr("idGiocatore");
            let puntata = $(this).parent().find(".txtPuntata").val();
            if (puntata <= 0) {
                alert("Puntata errata");
                return false;
            }

            $.ajax({
                type: "POST",
                url: "/Home/Punta",
                data: {
                    id: idPartita,
                    idGiocatore: idGiocatore,
                    puntata: puntata
                },
                success: function (json) {
                    let partita = JSON.parse(json);
                    DisegnaTavolo(partita);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnStai", function () {
            let idGiocatore = $(this).closest(".giocatore").attr("idGiocatore");
            let puntata = $(this).parent().find(".txtPuntata").val();

            $.ajax({
                type: "POST",
                url: "/Home/Stai",
                data: {
                    id: idPartita,
                    idGiocatore: idGiocatore,
                    puntata: puntata
                },
                success: function (json) {
                    let partita = JSON.parse(json);
                    DisegnaTavolo(partita);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnRaddoppia", function () {
            let idGiocatore = $(this).closest(".giocatore").attr("idGiocatore");
            let puntata = $(this).parent().find(".txtPuntata").val();

            $.ajax({
                type: "POST",
                url: "/Home/Raddoppia",
                data: {
                    id: idPartita,
                    idGiocatore: idGiocatore,
                    puntata: puntata
                },
                success: function (json) {
                    let partita = JSON.parse(json);
                    DisegnaTavolo(partita);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnEsci", function () {
            let idGiocatore = $(this).closest(".giocatore").attr("idGiocatore");
            let puntata = $(this).parent().find(".txtPuntata").val();

            $.ajax({
                type: "POST",
                url: "/Home/Esci",
                data: {
                    id: idPartita,
                    idGiocatore: idGiocatore,
                    puntata: puntata
                },
                success: function (json) {
                    location.href = "/";
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnPesca", function () {
            let idGiocatore = $(this).closest(".giocatore").attr("idGiocatore");
            let puntata = $(this).parent().find(".txtPuntata").val();

            $.ajax({
                type: "POST",
                url: "/Home/Pesca",
                data: {
                    id: idPartita,
                    idGiocatore: idGiocatore,
                    puntata: puntata
                },
                success: function (json) {
                    let partita = JSON.parse(json);
                    DisegnaTavolo(partita);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnPartecipa", function () {

            $.ajax({
                type: "POST",
                url: "/Home/Partecipa",
                data: {
                    id: idPartita,
                    nome: $(".txtNomeGiocatore").val()
                },
                success: function (data) {
                    $("#IdGiocatore").val(data.idGiocatore);
                    let partita = JSON.parse(data.json);
                    DisegnaTavolo(partita);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnSplit", function () {

            let idGiocatore = $(this).closest(".giocatore").attr("idGiocatore");

            $.ajax({
                type: "POST",
                url: "/Home/Split",
                data: {
                    id: idPartita,
                    idGiocatore: idGiocatore
                },
                success: function (json) {
                    let partita = JSON.parse(json);
                    DisegnaTavolo(partita);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);
                }
            });
        });

        $(document).on("click", ".btnNuovaMano", function () {
            NuovaMano();
            $(".giocatore .nome-giocatore:empty").closest(".giocatore").remove();
        });

        $(document).on("click", ".fiches-giocatore img", function () {
            var input = $(this).closest(".giocatore").find(".txtPuntata");
            if ($(this).attr("valore") == "x") {
                input.val("");
            } else {
                var valore = parseInt($(this).attr("valore"));
                var prec = parseInt(input.val());
                if (isNaN(prec)) {
                    prec = 0;
                }
                var nuovovalore = prec + valore;
                input.val(nuovovalore);
            }
        });


        GetPartita()
    })

    function GetPartita() {

        $.ajax({
            type: "POST",
            url: "/Home/GetPartita",
            data: {
                id: idPartita
            },
            success: function (json) {
                let partita = JSON.parse(json);
                DisegnaTavolo(partita);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
            }
        });

    }

    function DisegnaTavolo(partita, trueCount) {
        PulisceTavolo();
        $("#nome-mazziere").html(partita.Mazziere.Nome + (partita.Mazziere.CartaCoperta == false ? " punti: " + partita.Mazziere.Punteggio : ""));
        $("#cassa-mazziere").html("Cassa: " + partita.Mazziere.SoldiTotali + " - Giri: " + partita.Giri);
        partita.Mazziere.Carte.forEach(function (carta, index) {
            let left = index * 50 + 170 - partita.Mazziere.Carte.length * 25 + (($("#mazziere").width() - 400) / 2);

            if (partita.Mazziere.CartaCoperta == true && index == 1) {
                $("#carte-mazziere")
                    .append("<div class='carta sormonta' style='left:" + left + "px'><img src='/Carte/retro" + (partita.Mazzo.Retro == 0 ? "blu" : "rosso") + ".png'></div>");
            } else {
                $("#carte-mazziere")
                    .append("<div class='carta sormonta' style='left:" + left + "px'><img src='/" + carta.PathImage + "' title='" + carta.Nome + "'></div>");
            }
        })
        //if (partita.Mazziere.Punteggio > 21) {
        //    $("#mazziere").addClass("back-red");
        //}
        let presenteg = false;
        partita.Giocatori.forEach(function (giocatore) {
            let div = $("[idGiocatore='" + giocatore.Id + "']");
            let existdiv = div.length > 0;
            if (div.length == 0) {
                div = $(".giocatorestamp").clone().removeClass("giocatorestamp d-none").addClass("giocatore");
                div.attr("idGiocatore", giocatore.Id);
            }
            div.find(".nome-giocatore").html(giocatore.Nome + " punti: " + giocatore.Punteggio);
            div.find(".cassa-giocatore").html("Cassa: " + giocatore.SoldiTotali + " - Puntata: " + giocatore.PuntataCorrente);
            div.find(".perc").html("vinte: " + Math.round(giocatore.ManiVinte * 100 / partita.Giri) + "% - pareggiate: " + Math.round(Math.abs(giocatore.ManiVinte - giocatore.ManiPerse) * 100 / partita.Giri) + "% - perse: " + Math.round(giocatore.ManiPerse * 100 / partita.Giri) + "%");
            div.find(".carte-giocatore").empty();
            giocatore.Carte.forEach(function (carta, index) {
                let left = index * 50 + 170 - giocatore.Carte.length * 25 + ((div.closest(".giocatore").width() - 400)/2);
                div.find(".carte-giocatore")
                    .append("<div class='carta sormonta' style='left:" + left + "px'><img src='/" + carta.PathImage + "' title='" + carta.Nome + "'></div>");
            })
            //if (giocatore.Risultato == 0) {
            //    div.addClass("back-green");
            //} else if (giocatore.Risultato == 1) {
            //    div.addClass("back-red");
            //}
            if (giocatore.Id == $("#IdGiocatore").val() || giocatore.GiocatoreSplit != null && giocatore.GiocatoreSplit.Id == $("#IdGiocatore").val()) {
                if (giocatore.PuntataCorrente == 0) {
                    div.find(".txtPuntata").removeClass("d-none");
                    div.find(".btnPunta").removeClass("d-none");
                    div.find(".btnEsci").removeClass("d-none");
                    div.find(".fiches-giocatore").removeClass("d-none");
                } else {
                    div.find(".txtPuntata").addClass("d-none");
                    div.find(".btnPunta").addClass("d-none");
                    div.find(".btnEsci").addClass("d-none");
                    div.find(".fiches-giocatore").addClass("d-none");
                }
                if (giocatore.Id == partita.IdGiocatoreMano) {
                    div.find(".btnStai").removeClass("d-none");
                    div.find(".btnPesca").removeClass("d-none");
                } else {
                    div.find(".btnStai").addClass("d-none");
                    div.find(".btnPesca").addClass("d-none");
                }
                if (giocatore.Id == partita.IdGiocatoreMano && giocatore.Carte.length == 2) {
                    div.find(".btnRaddoppia").removeClass("d-none");
                } else {
                    div.find(".btnRaddoppia").addClass("d-none");
                }
                if (giocatore.CanSplit == true) {
                    div.find(".btnSplit").removeClass("d-none");
                } else {
                    div.find(".btnSplit").addClass("d-none");
                }

            }
            if (giocatore.Id == partita.IdGiocatoreMano) {
                div.addClass("back-azure");
            } else {
                div.removeClass("back-azure");
            }
            if (giocatore.Id == $("#IdGiocatore").val()) {
                presenteg=true;
            }

            if (!existdiv) {
                $("#giocatori").append(div);
            }

        })

        if (!presenteg && !partita.Iniziato) {
            $(".btnPartecipa").removeClass("d-none");
            $(".txtNomeGiocatore").removeClass("d-none");
        } else {
            $(".btnPartecipa").addClass("d-none");
            $(".txtNomeGiocatore").addClass("d-none");
        }

        //elimina i box
        $(".giocatore").map(function () {
            return $(this).attr("idgiocatore");
        }).get().forEach(function (item) {
            if (!partita.Giocatori.map(function (item) {
                return item.Id;
            }).includes(item)) {
                $("[idGiocatore='" + item + "']").remove();
            }
        });

        if (!partita.Mazziere.CartaCoperta) {
            VisualizzaVincitori(partita);
            $(".btnNuovaMano").removeClass("d-none");
            //    if (GetStop() == false) {
            //        SetStop(true);
            //        setTimeout(function () {
            //            NuovaMano();
            //            SetStop(false);
            //            $(".giocatore .nome-giocatore:empty").closest(".giocatore").remove();
            //        }, 5000);
            //    }
        } else {
            $(".btnNuovaMano").addClass("d-none");
        }

        if (partita.Mazzo.Scarti.length > 0) {
            $("#scarti img").attr("src", "/Carte/retro" + (partita.Mazzo.Retro == 0 ? "blu" : "rosso") + ".png");
            $("#scarti").removeClass("d-none");
            $("#num-scarti").html(partita.Mazzo.Scarti.length + " carte scartate<br>su " + partita.NumMazziIniziali + " mazzi");
        } else {
            $("#scarti").addClass("d-none");
        }
    }

    function PulisceTavolo() {
        $("#nome-mazziere").html("");
        $("#carte-mazziere").html("");
        $(".giocatore").removeClass("back-red back-green");
        $("#mazziere").removeClass("back-red back-green");
        $(".giocatore .nome-giocatore").html("");
        //$(".giocatore").remove();
        //$(".back-red").removeClass("back-red");
    }

    function NuovaMano() {

        $.ajax({
            type: "POST",
            url: "/Home/NuovaMano",
            data: {
                id: idPartita
            },
            success: function (json) {
                let partita = JSON.parse(json);
                DisegnaTavolo(partita);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
            }
        });

    }

    function VisualizzaVincitori(partita) {
        partita.Giocatori.forEach(function (giocatore) {
            let div = $("[idGiocatore='" + giocatore.Id + "']");
            if (giocatore.Risultato == 1) { //vinto
                div.addClass("back-green");
            } else if (giocatore.Risultato == 2) { //perso
                div.addClass("back-red");
            }
        })
        if (partita.Mazziere.Punteggio > 21) {
            $("#mazziere").addClass("back-red");
        }
    }

    function SetInterval() {
        var timer = setInterval(function () {
            GetPartita();
        }, 1000);
    }

    function GetStop() {
        let ret = false;
        $.ajax({
            url: "/Home/GetStop",
            async: false,
            success: function (data) {
                ret = data;
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
            }
        });
        return ret;
    }

    function SetStop(stop) {
        $.ajax({
            type: "POST",
            url: "/Home/SetStop",
            data: {
                stop: stop
            },
            success: function (json) {
                
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
            }
        });

    }


</script>